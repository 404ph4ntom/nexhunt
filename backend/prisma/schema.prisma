// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  HUNTER
  PROGRAM_OWNER
  ADMIN
}

enum ProgramType {
  WEB2
  WEB3
}

enum ProgramStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
}

enum ReportStatus {
  NEW
  TRIAGED
  NEEDS_MORE_INFO
  RESOLVED
  INFORMATIVE
  DUPLICATE
  OUT_OF_SCOPE
  DISCLOSED
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum PayoutMethod {
  PAYPAL
  WISE
  BANK_TRANSFER
  CRYPTO
  ON_CHAIN
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PAYOUT
  STATUS_CHANGE
}

model User {
  id                    String    @id @default(cuid())
  email                 String?   @unique
  emailVerified         DateTime?
  passwordHash          String?
  walletAddress         String?   @unique
  username              String    @unique
  displayName           String?
  avatar                String?
  bio                   String?
  role                  UserRole  @default(HUNTER)
  reputation            Int       @default(0)
  totalRewards          Decimal   @default(0) @db.Decimal(18, 2)
  isActive              Boolean   @default(true)
  twoFactorEnabled      Boolean   @default(false)
  twoFactorSecret       String?
  lastLogin             DateTime?
  language              String    @default("en")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // OAuth
  oauthProvider         String?
  oauthId               String?

  // Relations
  programs              Program[] @relation("ProgramOwner")
  teamMemberships       TeamMember[]
  submissions           Submission[]
  reports               Report[]
  payouts               Payout[]
  auditLogs             AuditLog[]

  @@index([email])
  @@index([walletAddress])
  @@index([username])
  @@index([role])
}

model TeamMember {
  id          String   @id @default(cuid())
  programId   String
  userId      String
  role        String   @default("member") // owner, admin, triager, member
  invitedBy   String?
  joinedAt    DateTime @default(now())
  createdAt   DateTime @default(now())

  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([programId, userId])
  @@index([programId])
  @@index([userId])
}

model Program {
  id                    String       @id @default(cuid())
  name                  String
  slug                  String       @unique
  description           String?      @db.Text
  type                  ProgramType
  status                ProgramStatus @default(DRAFT)
  isPublic              Boolean      @default(true)
  ownerId               String
  logo                  String?
  website               String?
  twitter               String?
  discord               String?
  
  // Web2 specific
  inScope               String?      @db.Text // JSON array of URLs/domains
  outOfScope            String?      @db.Text // JSON array of excluded items
  
  // Web3 specific
  chains                String?      // JSON array of chain IDs
  assets                String?      // JSON array of asset symbols with amounts
  
  // Bounty table
  bountyTable           String?      @db.Text // JSON: severity -> reward range
  
  // Settings
  disclosureSettings    String?      @db.Text // JSON
  slaSettings           String?      @db.Text // JSON
  allowPrivateReports   Boolean      @default(false)
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  owner                 User         @relation("ProgramOwner", fields: [ownerId], references: [id])
  teamMembers           TeamMember[]
  submissions           Submission[]
  reports               Report[]

  @@index([ownerId])
  @@index([slug])
  @@index([status])
  @@index([type])
  @@index([isPublic])
}

model Submission {
  id              String       @id @default(cuid())
  programId       String
  hunterId        String
  title           String
  description     String       @db.Text
  severity        Severity
  cvssScore       Float?
  cvssVector      String?
  status          ReportStatus @default(NEW)
  
  // Web3 specific
  affectedContract String?     @db.Text
  chainId         Int?
  transactionHash String?
  proofOfConcept  String?      @db.Text
  
  // Similarity detection
  embedding       Unsupported("vector(1536)")?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  program         Program      @relation(fields: [programId], references: [id], onDelete: Cascade)
  hunter          User         @relation(fields: [hunterId], references: [id])
  attachments     File[]
  comments        Comment[]
  report          Report?

  @@index([programId])
  @@index([hunterId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

model Report {
  id              String       @id @default(cuid())
  submissionId    String       @unique
  programId       String
  hunterId        String
  title           String
  content         String       @db.Text
  severity        Severity
  status          ReportStatus @default(NEW)
  rewardAmount    Decimal?     @db.Decimal(18, 2)
  rewardCurrency  String?
  triagedBy       String?
  triagedAt       DateTime?
  resolvedAt      DateTime?
  disclosedAt     DateTime?
  isDuplicate     Boolean      @default(false)
  duplicateOf     String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  submission      Submission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  program         Program      @relation(fields: [programId], references: [id])
  hunter          User         @relation(fields: [hunterId], references: [id])
  comments        Comment[]

  @@index([programId])
  @@index([hunterId])
  @@index([status])
  @@index([severity])
}

model Comment {
  id            String     @id @default(cuid())
  submissionId  String?
  reportId      String?
  userId        String
  content       String     @db.Text
  isInternal    Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  submission    Submission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  report        Report?     @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([reportId])
  @@index([userId])
}

model File {
  id            String      @id @default(cuid())
  submissionId  String?
  filename      String
  originalName  String
  mimeType      String
  size          Int
  s3Key         String      @unique
  s3Bucket      String
  encrypted     Boolean     @default(true)
  virusScanned  Boolean     @default(false)
  virusFree     Boolean?
  uploadedBy    String
  createdAt     DateTime    @default(now())

  submission    Submission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([s3Key])
}

model Payout {
  id              String        @id @default(cuid())
  reportId        String        @unique
  hunterId        String
  amount          Decimal       @db.Decimal(18, 2)
  currency        String
  method          PayoutMethod
  status          PayoutStatus  @default(PENDING)
  
  // Payment details (encrypted)
  paymentDetails  String?       @db.Text // Encrypted JSON
  
  // Crypto/on-chain
  transactionHash String?
  chainId         Int?
  fromAddress     String?
  toAddress       String?
  
  // Traditional payments
  processorId     String? // PayPal/Wise transaction ID
  processedAt     DateTime?
  
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  hunter          User          @relation(fields: [hunterId], references: [id])

  @@index([hunterId])
  @@index([status])
  @@index([method])
  @@index([createdAt])
}

model AuditLog {
  id            String      @id @default(cuid())
  userId        String?
  action        AuditAction
  resourceType  String
  resourceId    String?
  changes       String?     @db.Text // JSON diff
  ipAddress     String?
  userAgent     String?
  metadata      String?     @db.Text // JSON
  createdAt     DateTime    @default(now())

  user          User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
}

model Session {
  id            String      @id @default(cuid())
  userId        String
  token         String      @unique
  ipAddress     String?
  userAgent     String?
  expiresAt     DateTime
  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model RateLimit {
  id            String      @id @default(cuid())
  identifier    String      // IP or user ID
  endpoint      String
  count         Int         @default(1)
  windowStart   DateTime    @default(now())
  createdAt     DateTime    @default(now())

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier])
  @@index([windowStart])
}

